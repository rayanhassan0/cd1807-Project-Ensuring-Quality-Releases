name: Azure Pipelines

trigger:
- main

pool:
  name: myAgentPool

variables:
  python.version: '3.7.6'
  azureServiceConnectionId: 'udacity-az-sp'
  projectRoot: $(System.DefaultWorkingDirectory)
  environmentName: 'test'
  resourceGroup: 'Azuredevops'
  appServiceName: 'myapp-AppService'   # Ø³ÙŠØ¶Ø§Ù Ù„Ù‡Ø§ -$(Build.BuildId) ÙÙŠ plan/apply/destroy ÙˆÙ†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù†Ø´Ø± Ø£ÙŠØ¶Ø§Ù‹

stages:
# =============== BUILD ===============
- stage: Build
  jobs:
  - job: BuildInfrastructure
    displayName: 'Terraform + Postman + Package'
    steps:
    - task: AzureCLI@2
      displayName: 'Show Azure account'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: az account show

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
      displayName: 'Terraform installation'
      inputs:
        terraformVersion: '1.13.1'

    # ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø¨Ø§ÙƒØ¥Ù†Ø¯ Ù‚Ø¨Ù„ init
    - task: Bash@3
      displayName: 'Clean .terraform (ensure re-init)'
      inputs:
        targetType: inline
        script: |
          set -e
          rm -rf "$(System.DefaultWorkingDirectory)/terraform/environments/test/.terraform"

    # ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ù…Ù„ÙØ§Øª ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠØ±Ø§ÙÙˆØ±Ù… ØµØ­ÙŠØ­Ø©
    - task: Bash@3
      displayName: 'Debug: list terraform folder and modules'
      inputs:
        targetType: inline
        script: |
          set -e
          echo "---- env test ----"
          ls -la "$(System.DefaultWorkingDirectory)/terraform/environments/test"
          echo "---- modules/appservice ----"
          ls -la "$(System.DefaultWorkingDirectory)/terraform/modules/appservice" || true
          echo "---- modules/network ----"
          ls -la "$(System.DefaultWorkingDirectory)/terraform/modules/network" || true
          echo "---- terraform.tfvars ----"
          sed -n '1,200p' "$(System.DefaultWorkingDirectory)/terraform/environments/test/terraform.tfvars"

    # Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ®Ø²ÙŠÙ† backend (SA + container)
    - task: AzureCLI@2
      displayName: 'Ensure backend storage exists'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          RG="$(resourceGroup)"
          LOC="westus3"
          SA="tfstatebootstrap01"
          echo "Ensure SA=$SA RG=$RG LOC=$LOC"
          if ! az storage account show -g "$RG" -n "$SA" >/dev/null 2>&1; then
            az storage account create -g "$RG" -n "$SA" -l "$LOC" --sku Standard_LRS
          fi
          KEY=$(az storage account keys list -g "$RG" -n "$SA" --query "[0].value" -o tsv)
          az storage container create --name tfstate --account-name "$SA" --auth-mode key --account-key "$KEY" >/dev/null
          echo "Backend ready."

    # terraform init Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Service Connection (Ø¨Ø¯ÙˆÙ† MSI)
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
        backendServiceArm: '$(azureServiceConnectionId)'
        backendAzureRmResourceGroupName: '$(resourceGroup)'
        backendAzureRmStorageAccountName: 'tfstatebootstrap01'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'test.terraform.tfstate'
        backendAzureRmUseOidc: false
        backendAzureRmUseMsi: false

    # ====== (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù€ state â€” Ø§Ø­Ø°ÙÙ‡Ø§ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù†Ø¬Ø§Ø­ ======
    - task: AzureCLI@2
      displayName: 'TF import existing resources into state (one-time)'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd "$(System.DefaultWorkingDirectory)/terraform/environments/test"

          echo ">> Import VNet (vnet-test)"
          terraform import -input=false \
            'module.network.azurerm_virtual_network.vnet' \
            '/subscriptions/538cf8ed-3aac-4da8-84f9-3bc3a7a6869b/resourceGroups/Azuredevops/providers/Microsoft.Network/virtualNetworks/vnet-test' \
            || true

          echo ">> Import Subnet (subnet-test)"
          terraform import -input=false \
            'module.network.azurerm_subnet.subnet_test' \
            '/subscriptions/538cf8ed-3aac-4da8-84f9-3bc3a7a6869b/resourceGroups/Azuredevops/providers/Microsoft.Network/virtualNetworks/vnet-test/subnets/subnet-test' \
            || true

          echo ">> Import App Service Plan (myapp-plan)"
          terraform import -input=false \
            'module.appservice.azurerm_service_plan.plan' \
            '/subscriptions/538cf8ed-3aac-4da8-84f9-3bc3a7a6869b/resourceGroups/Azuredevops/providers/Microsoft.Web/serverFarms/myapp-plan' \
            || true

          echo "State after import:"
          terraform state list || true
    # ====== Ù†Ù‡Ø§ÙŠØ© Ø®Ø·ÙˆØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ======

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
        environmentServiceNameAzureRM: '$(azureServiceConnectionId)'

    # Terraform plan Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ø³Ù… ÙØ±ÙŠØ¯ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
        commandOptions: '-out=tfplan -var="app_service_name=$(appServiceName)-$(Build.BuildId)"'
        environmentServiceNameAzureRM: '$(azureServiceConnectionId)'

    # Terraform apply Ù…Ø¹ Ù†ÙØ³ Ø§Ù„-var
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
        commandOptions: '-auto-approve -var="app_service_name=$(appServiceName)-$(Build.BuildId)"'
        environmentServiceNameAzureRM: '$(azureServiceConnectionId)'

    # ====== ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¥ÙŠØ¬Ù†Øª (zip/unzip/pip) ======
    - task: Bash@3
      displayName: 'Install CLI deps (zip, unzip, pip)'
      inputs:
        targetType: inline
        script: |
          set -e
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y zip unzip python3-pip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y zip unzip python3-pip
          else
            echo "Unknown package manager; please install zip/unzip manually" >&2
            exit 1
          fi

    # ====== Node.js for Newman ======
    - task: NodeTool@0
      displayName: 'Use Node.js 18.x'
      inputs:
        versionSpec: '18.x'

    # Postman (Newman)
    - task: CmdLine@2
      displayName: 'Install Newman'
      inputs:
        script: 'npm install -g newman'
        workingDirectory: $(System.DefaultWorkingDirectory)

    - task: CmdLine@2
      displayName: 'Run Data Validation Tests'
      continueOnError: true
      inputs:
        script: |
          newman run TestSuite.Data-Validation.json \
                 -e Test.environment.json \
                 --reporters cli,junit \
                 --reporter-junit-export TEST-DataValidation.xml || true
        workingDirectory: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'

    - task: CmdLine@2
      displayName: 'Run Regression Tests'
      continueOnError: true
      inputs:
        script: |
          newman run TestSuite.Regression.json \
                 -e Test.environment.json \
                 --reporters cli,junit \
                 --reporter-junit-export TEST-Regression.xml || true
        workingDirectory: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'

    - task: PublishTestResults@2
      displayName: 'Publish Postman JUnit Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/TEST-*.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'
        mergeTestResults: true
        testRunTitle: 'Postman Results'

    # Selenium package
    - task: ArchiveFiles@2
      displayName: 'Archive UI Tests (Selenium)'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip
      displayName: 'Publish UI Tests Artifact'
      artifact: drop-uitests

    # FakeRestAPI package
    - task: ArchiveFiles@2
      displayName: 'Archive FakeRestAPI'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/jmeter/fakerestapi'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip
      displayName: 'Publish FakeRestAPI Artifact'
      artifact: drop-fakerestapi

    # JMeter package
    - task: ArchiveFiles@2
      displayName: 'Archive PerformanceTestSuite (JMeter)'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/jmeter'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip
      displayName: 'Publish Perf Tests Artifact'
      artifact: drop-perftests

# =============== DEPLOY ===============
- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: FakeRestAPI
    displayName: 'Deploy App & Run JMeter'
    pool:
      name: myAgentPool
    environment: $(environmentName)
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop-fakerestapi

          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: '$(azureServiceConnectionId)'
              # Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù‡ Terraform
              appName: '$(appServiceName)-$(Build.BuildId)'
              appType: 'webApp'
              package: '$(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip'

          - download: current
            artifact: drop-perftests

          - task: Bash@3
            displayName: 'Run JMeter (Performance)'
            inputs:
              targetType: inline
              script: |
                set -e
                cd "$(Pipeline.Workspace)"
                mkdir -p perf && cd perf
                # Java Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø·Ù„ÙˆØ¨Ø©: Ø¥Ø°Ø§ ÙØ´Ù„ jmeter Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ù€ "java: command not found" Ø³Ù†Ø¶ÙŠÙ ØªØ«Ø¨ÙŠØª Java
                curl -L -o apache-jmeter.tgz https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
                tar -xzf apache-jmeter.tgz
                unzip -o "$(Pipeline.Workspace)/drop-perftests/$(Build.BuildId)-perftests.zip" -d perftests
                JM="$(pwd)/apache-jmeter-5.6.3"
                JMX="perftests/PerformanceTestSuite.jmx"
                if [ ! -f "$JMX" ]; then
                  echo "JMeter test file not found: $JMX" && exit 1
                fi
                # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠØ¯ Ù†ÙØ³Ù‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ URL
                HN=$(az webapp show -g "$(resourceGroup)" -n "$(appServiceName)-$(Build.BuildId)" --query defaultHostName -o tsv)
                APPURL="https://$HN"
                echo "Testing against: $APPURL"
                "$JM/bin/jmeter" -n -t "$JMX" -JAPPSERVICEURL="$APPURL" -l perftests/results.jtl -e -o perftests/html-report || true
                echo "JMeter done."

          - task: PublishBuildArtifacts@1
            displayName: 'Publish JMeter HTML Report'
            inputs:
              PathtoPublish: '$(Pipeline.Workspace)/perf/perftests/html-report'
              ArtifactName: 'jmeter-report'
              publishLocation: 'Container'

  # ğŸš€ ØªØ´ØºÙŠÙ„ Ø³ÙŠÙ„ÙŠÙ†ÙŠÙˆÙ… Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù€ self-hosted agent Ø¨Ø¯ÙˆÙ† Environment
  - job: SeleniumUITests
    displayName: 'Selenium UI Tests'
    pool:
      name: myAgentPool
    steps:
    - download: current
      artifact: drop-uitests
    - task: Bash@3
      displayName: 'Run Selenium'
      inputs:
        targetType: 'inline'
        script: |
          set -e
          mkdir -p "$HOME/selenium"
          unzip -o "$(Pipeline.Workspace)/drop-uitests/$(Build.BuildId)-uitests.zip" -d "$HOME/selenium"
          python3 -m pip install --user -r "$HOME/selenium/requirements.txt" || true
          export DEMO_URL="https://www.saucedemo.com/"
          export DEMO_USER="standard_user"
          export DEMO_PASS="secret_sauce"
          python3 "$HOME/selenium/login.py" || true
          echo "Selenium finished."

# =============== CLEANUP ===============
- stage: Cleanup
  displayName: 'Terraform Destroy'
  dependsOn: Deploy
  condition: always()
  jobs:
  - job: Destroy
    pool:
      name: myAgentPool
    steps:
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
      displayName: 'Terraform installation (Cleanup)'
      inputs:
        terraformVersion: '1.13.1'

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform destroy'
      inputs:
        provider: 'azurerm'
        command: 'destroy'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
        commandOptions: '-auto-approve -var="app_service_name=$(appServiceName)-$(Build.BuildId)"'
        environmentServiceNameAzureRM: '$(azureServiceConnectionId)'
