name: Azure Pipelines
trigger:
- main

# self-hosted agent
pool:
  name: myAgentPool

variables:
  azureServiceConnectionId: 'udacity-az-sp'
  resourceGroup: 'Azuredevops'
  storageAccount: 'stb0f0bb7d'
  storageContainer: 'tfstate'
  tfstateKey: 'test.terraform.tfstate'
  appServiceName: 'fakerest-$(Build.BuildId)'   # اسم فريد لكل Run
  vmEnvName: 'myEnvVM'

stages:
# ===========================
# BUILD (Terraform + Postman + JMeter artifacts)
# ===========================
- stage: Build
  displayName: 'Build: Terraform + Package + API/Load'
  jobs:
  - job: BuildInfrastructure
    displayName: 'Terraform & Package & Tests'
    steps:
    - checkout: self

    # --- Install Terraform 1.6.6
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
      displayName: 'Install Terraform 1.6.6'
      inputs:
        terraformVersion: '1.6.6'

    # --- Login to Azure (via service connection)
    - task: AzureCLI@2
      displayName: 'Az Login (Service Connection)'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    # --- Get storage account key into pipeline secret var
    - task: AzureCLI@2
      displayName: 'Get Storage Account Key'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          KEY=$(az storage account keys list -g "$(resourceGroup)" -n "$(storageAccount)" --query "[0].value" -o tsv)
          echo "##vso[task.setvariable variable=TF_STORAGE_KEY;issecret=true]$KEY"

    # --- Write backend.tf using access_key (so TF won't try MSI)
    - task: Bash@3
      displayName: 'Write backend.tf'
      inputs:
        targetType: inline
        script: |
          mkdir -p $(System.DefaultWorkingDirectory)/terraform/environments/test
          cat > $(System.DefaultWorkingDirectory)/terraform/environments/test/backend.tf << 'EOF'
          terraform {
            backend "azurerm" {
              storage_account_name = "$(storageAccount)"
              container_name       = "$(storageContainer)"
              key                  = "$(tfstateKey)"
              access_key           = "$(TF_STORAGE_KEY)"
            }
          }
          EOF
          echo "backend.tf written."

    # --- Terraform init via bash (no interactive input)
    - task: Bash@3
      displayName: 'Terraform init'
      inputs:
        targetType: inline
        script: |
          set -e
          cd $(System.DefaultWorkingDirectory)/terraform/environments/test
          terraform init -input=false
          terraform version

    # --- Terraform validate (still fine with the task)
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: 'Terraform validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'

    # --- Terraform apply (pass tfvars + disable input)
    - task: Bash@3
      displayName: 'Terraform apply (-var-file, -input=false)'
      inputs:
        targetType: inline
        script: |
          set -euo pipefail
          cd $(System.DefaultWorkingDirectory)/terraform/environments/test
          export TF_LOG_PATH=$(System.DefaultWorkingDirectory)/tf-apply.log
          terraform apply -auto-approve -input=false -no-color -var-file="terraform.tfvars" -lock-timeout=5m -parallelism=2
          echo "----- tail tf-apply.log (if exists) -----"
          tail -n 200 $(System.DefaultWorkingDirectory)/tf-apply.log || true

    # -------- Archive UI tests (Selenium)
    - task: ArchiveFiles@2
      displayName: 'Archive UI Tests (Selenium)'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip
      displayName: 'Publish UI Tests Artifact'
      artifact: drop-uitests

    # -------- Archive FakeRestAPI (App)
    - task: ArchiveFiles@2
      displayName: 'Archive FakeRestAPI'
      inputs:
        rootFolderOrFile: 'FakeRestAPI'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip
      displayName: 'Publish FakeRestAPI Artifact'
      artifact: drop-fakerestapi

    # -------- Archive JMeter test plan
    - task: ArchiveFiles@2
      displayName: 'Archive PerformanceTestSuite (JMeter)'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/jmeter'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip
      displayName: 'Publish Perf Tests Artifact'
      artifact: drop-perftests

    # -------- Newman (Postman)
    - task: CmdLine@2
      displayName: 'Install Newman'
      inputs:
        script: 'sudo npm install -g newman'
        workingDirectory: $(System.DefaultWorkingDirectory)

    - task: CmdLine@2
      displayName: 'Run Data Validation Tests'
      continueOnError: true
      inputs:
        script: |
          cd automatedtesting/postman
          newman run TestSuite.Data-Validation.json -e Test.environment.json --reporters cli,junit --reporter-junit-export TEST-DataValidation.xml
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: CmdLine@2
      displayName: 'Run Regression Tests'
      continueOnError: true
      inputs:
        script: |
          cd automatedtesting/postman
          newman run TestSuite.Regression.json -e Test.environment.json --reporters cli,junit --reporter-junit-export TEST-Regression.xml
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: PublishTestResults@2
      displayName: 'Publish Postman JUnit Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/TEST-*.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'
        mergeTestResults: true
        testRunTitle: 'Postman Results'

# ===========================
# DEPLOY (WebApp + JMeter)
# ===========================
- stage: Deploy
  displayName: 'Deploy WebApp & Run JMeter'
  dependsOn: Build
  jobs:
  - deployment: FakeRestAPI
    displayName: 'Deploy App & Run Load Tests'
    pool:
      name: myAgentPool
    environment: $(vmEnvName)
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop-fakerestapi

          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: '$(azureServiceConnectionId)'
              appName: '$(appServiceName)'
              appType: 'webApp'
              package: '$(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip'

          - task: AzureCLI@2
            displayName: 'Get App URL'
            inputs:
              azureSubscription: '$(azureServiceConnectionId)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                HN=$(az webapp show -g "$(resourceGroup)" -n "$(appServiceName)" --query defaultHostName -o tsv)
                echo "##vso[task.setvariable variable=APPSERVICEURL;isOutput=true]https://$HN"
                echo "App URL: https://$HN"
            name: appurl

          - task: CmdLine@2
            displayName: 'Run JMeter (Performance)'
            inputs:
              script: |
                set -e
                export JM=/opt/jmeter
                unzip -o $(Pipeline.Workspace)/drop-perftests/$(Build.BuildId)-perftests.zip -d perftests
                $JM/bin/jmeter -n -t perftests/Starter.jmx -JAPPSERVICEURL=$(appurl.APPSERVICEURL) -l perftests/results.jtl -e -o perftests/html-report
                echo "===== JMETER LOG (tail) ====="
                tail -n 100 ~/.jmeter/jmeter.log || true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish JMeter HTML Report'
            inputs:
              PathtoPublish: 'perftests/html-report'
              ArtifactName: 'jmeter-report'
              publishLocation: 'Container'

# ===========================
# UI TESTS (Selenium on VM)
# ===========================
- stage: UITests
  displayName: 'Selenium on Agent VM'
  dependsOn: Deploy
  jobs:
  - deployment: VMDeploy
    displayName: 'Run Selenium'
    environment:
      name: $(vmEnvName)
      resourceType: VirtualMachine
      tags: selenium
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop-uitests
          - task: Bash@3
            displayName: 'Execute Selenium'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                python3 -m pip install --user -r $(Pipeline.Workspace)/drop-uitests/requirements.txt --break-system-packages || true
                export DEMO_URL="https://www.saucedemo.com/"
                export DEMO_USER="standard_user"
                export DEMO_PASS="secret_sauce"
                sudo mkdir -p /var/log/selenium && sudo chown $USER:$USER /var/log/selenium
                python3 $(Pipeline.Workspace)/drop-uitests/login.py
                echo "Selenium log tail:"
                tail -n 120 /var/log/selenium/selenium.log || true

# ===========================
# CLEANUP
# ===========================
- stage: Cleanup
  displayName: 'Terraform Destroy'
  dependsOn: UITests
  jobs:
  - job: Destroy
    pool:
      name: myAgentPool
    steps:
    - task: AzureCLI@2
      displayName: 'Az Login'
      inputs:
        azureSubscription: '$(azureServiceConnectionId)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    # destroy مع -var-file و -input=false
    - task: Bash@3
      displayName: 'Terraform destroy (-var-file, -input=false)'
      inputs:
        targetType: inline
        script: |
          set -e
          cd $(System.DefaultWorkingDirectory)/terraform/environments/test
          terraform destroy -auto-approve -input=false -no-color -var-file="terraform.tfvars"
